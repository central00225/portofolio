<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Espace Client - CH.TRANSIT</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="fontawesome.min.css">
</head>
<body>
  <header>
    <nav>
      <ul>
        <li><a href="index.html">Accueil</a></li>
        <li><a href="about.html">À propos</a></li>
        <li><a href="espace-client.html">Espace Client</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <section>
      <h1>Espace Client</h1>
      <div id="auth-choice" style="display:flex;flex-direction:column;align-items:center;gap:1.5rem;margin-bottom:2rem;">
        <button id="show-login" class="devis-btn" style="width:220px;">Se connecter</button>
        <span>ou</span>
        <button id="show-register-btn" class="devis-btn" style="width:220px;background:#00bcd4;">Créer un compte</button>
      </div>
      <form id="client-login-form" class="devis-form-style" style="display:none;">
        <div class="devis-group">
          <label for="client-email"><i class="fa-solid fa-envelope icon"></i> Email :</label>
          <input type="email" id="client-email" required placeholder="Votre email">
        </div>
        <div class="devis-group">
          <label for="client-password"><i class="fa-solid fa-lock icon"></i> Mot de passe :</label>
          <input type="password" id="client-password" required placeholder="Votre mot de passe">
        </div>
        <button type="submit" class="devis-btn">Connexion</button>
        <div id="client-login-feedback" style="display:none;color:green;margin-top:1em;font-weight:bold;">Connexion réussie !</div>
      </form>
      <p id="register-link" style="display:none;">Pas encore de compte ? <a href="#" id="show-register">Inscrivez-vous ici</a></p>
      <form id="client-register-form" class="devis-form-style" style="display:none;">
        <div class="devis-group">
          <label for="register-email"><i class="fa-solid fa-envelope icon"></i> Email :</label>
          <input type="email" id="register-email" required placeholder="Votre email">
        </div>
        <div class="devis-group">
          <label for="register-password"><i class="fa-solid fa-lock icon"></i> Mot de passe :</label>
          <input type="password" id="register-password" required placeholder="Choisissez un mot de passe">
        </div>
        <button type="submit" class="devis-btn">Créer mon compte</button>
        <div id="client-register-feedback" style="display:none;color:green;margin-top:1em;font-weight:bold;">Compte créé !</div>
      </form>
      <form id="client-add-colis-form" class="devis-form-style" style="display:none; margin-top:2rem;" action="https://formspree.io/f/xzzvella" method="POST" enctype="multipart/form-data">
        <h2>Ajouter un colis</h2>
        <input type="hidden" name="_subject" value="Nouveau colis ajouté via Espace Client">
        <input type="hidden" name="_next" value="https://central00225.github.io/portofolio/espace-client.html?success=1">
        <div class="devis-group">
          <label for="colis-suivi"><i class="fa-solid fa-hashtag icon"></i> Numéro de suivi :</label>
          <input type="text" id="colis-suivi" name="Numéro de suivi" required placeholder="Numéro de suivi du colis">
        </div>
        <div class="devis-group">
          <label for="colis-description"><i class="fa-solid fa-box icon"></i> Description du colis :</label>
          <input type="text" id="colis-description" name="Description" required placeholder="Ex : vêtements, téléphone, etc.">
        </div>
        <div class="devis-group">
          <label for="colis-nombre"><i class="fa-solid fa-list-ol icon"></i> Nombre d'articles :</label>
          <input type="number" id="colis-nombre" name="Nombre d'articles" min="1" required placeholder="Ex : 3">
        </div>
        <div class="devis-group">
          <label for="colis-prix"><i class="fa-solid fa-money-bill-wave icon"></i> Prix d'achat (FCFA) :</label>
          <input type="number" id="colis-prix" name="Prix d'achat" min="0" step="0.01" required placeholder="Ex : 25000">
        </div>
        <div class="devis-group">
          <label for="colis-capture"><i class="fa-solid fa-image icon"></i> Capture du colis (page vendeur) :</label>
          <input type="file" id="colis-capture" name="Capture" accept="image/*" required>
        </div>
        <button type="submit" class="devis-btn">Ajouter le colis</button>
        <div id="colis-feedback" style="display:none;color:green;margin-top:1em;font-weight:bold;">Votre colis a bien été envoyé ! Vous recevrez une confirmation par email.</div>
      </form>
    </section>
    <section id="mes-colis-section" style="display:none;">
      <h2>Mes Colis</h2>
      <div id="mes-colis-list" style="display:flex;flex-direction:column;gap:1.2rem;"></div>
    </section>
  </main>
  <!-- Bouton flottant pour ajouter un colis -->
  <button id="add-colis-float" style="display:none;position:fixed;right:24px;bottom:24px;background:#ff9800;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 4px 16px rgba(0,0,0,0.18);z-index:10000;cursor:pointer;font-size:2em;align-items:center;justify-content:center;">
    <i class="fa-solid fa-plus"></i>
  </button>
  <!-- Bouton flottant WhatsApp -->
  <a href="https://wa.me/2250713916946" target="_blank" id="whatsapp-float" style="position:fixed;bottom:100px;left:24px;z-index:10001;background:#25d366;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,0.18);">
    <img src="logo-chtransit.png" alt="WhatsApp" style="width:32px;height:32px;">
  </a>
  <!-- Tidio Chatbot -->
  <script src="//code.tidio.co/oudf8onhu4oqfhtucpfsa1d9wzvtyvu1.js" async></script>
  <footer>
    <div class="footer-contact">
      WhatsApp : <a href="https://wa.me/2250713916946" target="_blank">+225 07 13 91 69 46</a>
      | Email : <a href="mailto:contact@chtransit.com">contact@chtransit.com</a>
    </div>
    <p>&copy; 2025 CH.TRANSIT</p>
  </footer>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAFX50c2zieXIfT3IgRcZi5hJrhNl7jsCg",
      authDomain: "chtransit-colis.firebaseapp.com",
      projectId: "chtransit-colis",
      storageBucket: "chtransit-colis.firebasestorage.app",
      messagingSenderId: "604932820444",
      appId: "1:604932820444:web:e595dd325b2a76cec01319",
      measurementId: "G-FHEL4N0RWY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Afficher le formulaire de connexion quand on clique sur "Ajouter un colis"
    document.getElementById('btn-ajouter-colis').onclick = function() {
      document.getElementById('btn-ajouter-colis').style.display = 'none';
      document.getElementById('client-login-form').style.display = 'block';
      document.getElementById('register-link').style.display = 'block';
    };
    // Affichage du formulaire d'inscription
    document.getElementById('show-register').onclick = function(e) {
      e.preventDefault();
      document.getElementById('client-login-form').style.display = 'none';
      document.getElementById('client-register-form').style.display = 'block';
      document.getElementById('register-link').style.display = 'none';
    };
    // Feedback visuel connexion (démo, pas de backend)
    document.getElementById('client-login-form').onsubmit = function(e) {
      e.preventDefault();
      document.getElementById('client-login-feedback').style.display = 'block';
      setTimeout(function(){ document.getElementById('client-login-feedback').style.display = 'none'; }, 2000);
      setTimeout(function(){
        document.querySelector('section').style.display = 'none';
        document.getElementById('mes-colis-section').style.display = 'block';
        document.getElementById('add-colis-float').style.display = 'flex';
        renderColis();
      }, 2200);
    };
    // Afficher la page Mes Colis après connexion
    document.getElementById('client-login-form').onsubmit = function(e) {
      e.preventDefault();
      document.getElementById('client-login-feedback').style.display = 'block';
      setTimeout(function(){ document.getElementById('client-login-feedback').style.display = 'none'; }, 2000);
      setTimeout(function(){
        document.querySelector('section').style.display = 'none';
        document.getElementById('mes-colis-section').style.display = 'block';
        document.getElementById('add-colis-float').style.display = 'flex';
        renderColis();
      }, 2200);
    };
    // Bouton flottant pour afficher le formulaire d'ajout
    document.getElementById('add-colis-float').onclick = function() {
      document.getElementById('mes-colis-section').style.display = 'none';
      document.getElementById('client-add-colis-form').style.display = 'block';
      document.getElementById('add-colis-float').style.display = 'none';
    };
    // Après ajout d'un colis, revenir à la liste
    if (colisForm) {
      colisForm.onsubmit = async function(e) {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) return alert('Vous devez être connecté.');
        const suivi = document.getElementById('colis-suivi').value;
        const desc = document.getElementById('colis-description').value;
        const nombre = document.getElementById('colis-nombre').value;
        const prix = document.getElementById('colis-prix').value;
        let captureUrl = '';
        const captureFile = document.getElementById('colis-capture').files[0];
        if (captureFile) {
          // Pour la démo, on encode l'image en base64 (pas optimal pour de gros fichiers)
          const reader = new FileReader();
          reader.onload = async function(evt) {
            captureUrl = evt.target.result;
            await db.collection('colis').add({
              userId: user.uid,
              suivi,
              desc,
              nombre,
              prix,
              capture: captureUrl,
              createdAt: new Date()
            });
            document.getElementById('colis-feedback').style.display = 'block';
            setTimeout(() => { document.getElementById('colis-feedback').style.display = 'none'; }, 2000);
            colisForm.reset();
            document.getElementById('client-add-colis-form').style.display = 'none';
            document.getElementById('mes-colis-section').style.display = 'block';
            document.getElementById('add-colis-float').style.display = 'flex';
            renderColis();
          };
          reader.readAsDataURL(captureFile);
        } else {
          await db.collection('colis').add({
            userId: user.uid,
            suivi,
            desc,
            nombre,
            prix,
            capture: '',
            createdAt: new Date()
          });
          document.getElementById('colis-feedback').style.display = 'block';
          setTimeout(() => { document.getElementById('colis-feedback').style.display = 'none'; }, 2000);
          colisForm.reset();
          document.getElementById('client-add-colis-form').style.display = 'none';
          document.getElementById('mes-colis-section').style.display = 'block';
          document.getElementById('add-colis-float').style.display = 'flex';
          renderColis();
        }
      };
    }
    // Simuler la liste des colis (stockés en mémoire pour la démo)
    let mesColis = [];
    // Fonction pour afficher la liste des colis
    async function renderColis() {
      const user = auth.currentUser;
      if (!user) return;
      const list = document.getElementById('mes-colis-list');
      list.innerHTML = '<p>Chargement...</p>';
      const snapshot = await db.collection('colis').where('userId', '==', user.uid).orderBy('createdAt', 'desc').get();
      if (snapshot.empty) {
        list.innerHTML = '<p>Aucun colis ajouté pour le moment.</p>';
      } else {
        list.innerHTML = '';
        snapshot.forEach(doc => {
          const colis = doc.data();
          const div = document.createElement('div');
          div.className = 'colis-card';
          div.style = 'background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,82,204,0.08);padding:1.2rem;display:flex;gap:1.2rem;align-items:center;';
          div.innerHTML = `<div style='flex:1;'>
            <strong>Suivi :</strong> ${colis.suivi}<br>
            <strong>Description :</strong> ${colis.desc}<br>
            <strong>Nombre d'articles :</strong> ${colis.nombre}<br>
            <strong>Prix d'achat :</strong> ${colis.prix} FCFA
          </div>
          ${colis.capture ? `<img src='${colis.capture}' alt='Capture colis' style='width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #eee;'/>` : ''}
          <button onclick="editColis('${doc.id}', ${JSON.stringify(colis).replace(/"/g, '&quot;')})" style="background:#ff9800;color:#fff;border:none;border-radius:6px;padding:0.5em 1em;cursor:pointer;margin-left:1em;">Modifier</button>
          <button onclick="deleteColis('${doc.id}')" style="background:#e53935;color:#fff;border:none;border-radius:6px;padding:0.5em 1em;cursor:pointer;margin-left:1em;">Supprimer</button>`;
          list.appendChild(div);
        });
      }
    }
    // Fonction de suppression de colis
    async function deleteColis(id) {
      if (confirm('Supprimer ce colis ?')) {
        await db.collection('colis').doc(id).delete();
        renderColis();
      }
    }
    // Rafraîchir la liste après connexion
    if (window.auth) {
      auth.onAuthStateChanged(function(user) {
        if (user) renderColis();
      });
    }
  </script>
  <script>
    // Gestion inscription
    const registerForm = document.getElementById('client-register-form');
    if (registerForm) {
      registerForm.onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        auth.createUserWithEmailAndPassword(email, password)
          .then(() => {
            document.getElementById('client-register-feedback').textContent = 'Compte créé ! Connectez-vous.';
            document.getElementById('client-register-feedback').style.display = 'block';
            setTimeout(() => {
              document.getElementById('client-register-feedback').style.display = 'none';
              document.getElementById('client-register-form').style.display = 'none';
              document.getElementById('client-login-form').style.display = 'block';
              document.getElementById('register-link').style.display = 'block';
            }, 2000);
          })
          .catch(err => {
            document.getElementById('client-register-feedback').textContent = err.message;
            document.getElementById('client-register-feedback').style.display = 'block';
          });
      };
    }
    // Gestion connexion
    const loginForm = document.getElementById('client-login-form');
    if (loginForm) {
      loginForm.onsubmit = function(e) {
        e.preventDefault();
        const email = document.getElementById('client-email').value;
        const password = document.getElementById('client-password').value;
        auth.signInWithEmailAndPassword(email, password)
          .then(() => {
            document.getElementById('client-login-feedback').textContent = 'Connexion réussie !';
            document.getElementById('client-login-feedback').style.display = 'block';
            setTimeout(() => {
              document.getElementById('client-login-feedback').style.display = 'none';
              document.querySelector('section').style.display = 'none';
              document.getElementById('mes-colis-section').style.display = 'block';
              document.getElementById('add-colis-float').style.display = 'flex';
            }, 2000);
          })
          .catch(err => {
            document.getElementById('client-login-feedback').textContent = err.message;
            document.getElementById('client-login-feedback').style.display = 'block';
          });
      };
    }
    // Déconnexion (optionnel)
    function logout() {
      auth.signOut().then(() => {
        location.reload();
      });
    }
    // Affichage dynamique selon l'état de connexion
    auth.onAuthStateChanged(function(user) {
      if (user) {
        document.querySelector('section').style.display = 'none';
        document.getElementById('mes-colis-section').style.display = 'block';
        document.getElementById('add-colis-float').style.display = 'flex';
      } else {
        document.querySelector('section').style.display = 'block';
        document.getElementById('mes-colis-section').style.display = 'none';
        document.getElementById('add-colis-float').style.display = 'none';
      }
    });
    // Ajout d'un bouton de déconnexion
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'Déconnexion';
    logoutBtn.style = 'position:fixed;top:24px;right:24px;background:#0052cc;color:#fff;border:none;border-radius:8px;padding:0.7em 1.5em;z-index:10001;cursor:pointer;font-weight:bold;';
    logoutBtn.onclick = function() { auth.signOut(); };
    auth.onAuthStateChanged(function(user) {
      if (user) {
        if (!document.getElementById('logout-btn')) {
          logoutBtn.id = 'logout-btn';
          document.body.appendChild(logoutBtn);
        }
      } else {
        if (document.getElementById('logout-btn')) {
          document.getElementById('logout-btn').remove();
        }
      }
    });
    // Ajout de la modification de colis
    async function editColis(id, oldData) {
      // Affiche le formulaire pré-rempli
      document.getElementById('mes-colis-section').style.display = 'none';
      document.getElementById('client-add-colis-form').style.display = 'block';
      document.getElementById('add-colis-float').style.display = 'none';
      document.getElementById('colis-suivi').value = oldData.suivi;
      document.getElementById('colis-description').value = oldData.desc;
      document.getElementById('colis-nombre').value = oldData.nombre;
      document.getElementById('colis-prix').value = oldData.prix;
      // On ne peut pas pré-remplir le file input pour la capture
      // Change le bouton submit pour "Modifier"
      const submitBtn = document.querySelector('#client-add-colis-form button[type=submit]');
      const oldText = submitBtn.textContent;
      submitBtn.textContent = 'Modifier le colis';
      // Remplace le handler temporairement
      const form = document.getElementById('client-add-colis-form');
      const oldHandler = form.onsubmit;
      form.onsubmit = async function(e) {
        e.preventDefault();
        const suivi = document.getElementById('colis-suivi').value;
        const desc = document.getElementById('colis-description').value;
        const nombre = document.getElementById('colis-nombre').value;
        const prix = document.getElementById('colis-prix').value;
        let captureUrl = oldData.capture;
        const captureFile = document.getElementById('colis-capture').files[0];
        if (captureFile) {
          const reader = new FileReader();
          reader.onload = async function(evt) {
            captureUrl = evt.target.result;
            await db.collection('colis').doc(id).update({ suivi, desc, nombre, prix, capture: captureUrl });
            afterEdit();
          };
          reader.readAsDataURL(captureFile);
        } else {
          await db.collection('colis').doc(id).update({ suivi, desc, nombre, prix });
          afterEdit();
        }
        function afterEdit() {
          form.reset();
          form.onsubmit = oldHandler;
          submitBtn.textContent = oldText;
          document.getElementById('client-add-colis-form').style.display = 'none';
          document.getElementById('mes-colis-section').style.display = 'block';
          document.getElementById('add-colis-float').style.display = 'flex';
          renderColis();
        }
      };
    }
    // Export CSV
    function exportColisCSV() {
      const user = auth.currentUser;
      if (!user) return;
      db.collection('colis').where('userId', '==', user.uid).orderBy('createdAt', 'desc').get().then(snapshot => {
        let csv = 'Numéro de suivi,Description,Nombre d\'articles,Prix d\'achat\n';
        snapshot.forEach(doc => {
          const c = doc.data();
          csv += `${c.suivi},${c.desc},${c.nombre},${c.prix}\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mes_colis.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }
    // Ajout bouton export
    if (!document.getElementById('export-csv-btn')) {
      const exportBtn = document.createElement('button');
      exportBtn.id = 'export-csv-btn';
      exportBtn.textContent = 'Exporter mes colis (CSV)';
      exportBtn.style = 'margin:1em 0;background:#00bcd4;color:#fff;border:none;border-radius:8px;padding:0.7em 1.5em;cursor:pointer;font-weight:bold;';
      exportBtn.onclick = exportColisCSV;
      document.getElementById('mes-colis-section').prepend(exportBtn);
    }
  </script>
</body>
</html>
